using System;
using MM.Events;
using UnityEngine;
using Random = UnityEngine.Random;

namespace MM.Entities.Enemies.Bosses.Iset.SubModuleBosses
{
    public class HookSubBoss : SubBoss
    {
        #region Private Variables

        [SerializeField] private float timeBetweenAttacks = 1f;
        [SerializeField] private HookAttack[] hookAttacks;
        
        private float _currentTimer;
        private bool _isAttacking;
        private bool _isPlayerSpawned;
        private bool _isMovingRight;

        #endregion

        #region Monbehaviour Functions

        protected override void Awake()
        {
            base.Awake();
            
            EventManager.Instance.Subscribe(NameEvent.OnPlayerSpawned, OnPlayerSpawned);
            
            _currentTimer = timeBetweenAttacks;
            
            _isMovingRight = Random.Range(0, 2) == 0;
        }

        private void Update()
        {
            if(!_isPlayerSpawned) { return; }

            Move();
            
            if(_isAttacking) { return; }
            
            if (_currentTimer > 0)
            {
                _currentTimer -= Time.deltaTime;
            }
            else
            {
                ChooseAttack();
            }
        }

        private void OnCollisionEnter(Collision other)
        {
            if (other.gameObject.layer == 7)
            {
                _isMovingRight = !_isMovingRight;
            }
        }

        #endregion

        #region Public Functions

        public void ResetTimer()
        {
            _currentTimer = timeBetweenAttacks;
            _isAttacking = false;
        }

        #endregion

        #region Private Functions

        private void Move()
        {
            if(_isMovingRight)
            {
                transform.position += Vector3.right * (Time.deltaTime * movementSpeed);
            }
            else
            {
                transform.position += Vector3.left * (Time.deltaTime * movementSpeed);
            }
        }

        private void ChooseAttack()
        {
            _isAttacking = true;
            var attackValue = Random.Range(0, hookAttacks.Length);
            hookAttacks[attackValue].Shot();
        }

        #endregion

        #region Event Functions

        private void OnPlayerSpawned(params object[] parameters)
        {
            _isPlayerSpawned = true;
        }

        #endregion
    }
}