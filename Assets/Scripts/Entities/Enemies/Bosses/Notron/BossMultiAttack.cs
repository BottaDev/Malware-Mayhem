using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

[Serializable]
public class BossMultiAttack : SubmoduleAttack
{
    // Override the time after executing
    public float timeAfter = 10f;
    
    [Header("Pattern Parameters")]
    public string patternName;
    public List<MultiAttack> multiAttacks;
    
    private NotronMobilizer _mobilizer;
    private NotronCannon _cannon;

    protected override void Start()
    {
        base.Start();
        _mobilizer = GetComponentInParent<NotronMobilizer>();
        _cannon = GetComponent<NotronCannon>();
    }
    
    public override void MakeAction()
    {
        base.MakeAction();
        StartShooting();
    }
    
    private void StartShooting()
    {
        if (this == null || 
            !gameObject.activeInHierarchy) 
            return;
        
        StartCoroutine(MakeAttack());
    }
    
    private IEnumerator MakeAttack()
    {
        foreach (var multiAttack in multiAttacks)
        {
            // Break the loop if the boss is stunned
            if (_submodule.GetIsStunned())
                yield return null;

            if (multiAttack.stopMovement)
                _mobilizer.StopMovement();
            
            switch (multiAttack.attackType)
            {
                case MultiAttackType.ContinuousLaser:
                    StartCoroutine(SpawnLaser(multiAttack.laserDuration, multiAttack.initialDelay));
                    break;
                
                case MultiAttackType.CannonBall:
                    StartCoroutine(CannonBall(multiAttack.initialDelay));
                    break;
                
                default:
                case MultiAttackType.Bullets:
                    StartCoroutine(SpawnBullets(multiAttack.fireRate, multiAttack.bulletCount, multiAttack.initialDelay, multiAttack.projectile));
                    break;
            }
            
            if (multiAttack.stopMovement)
                _mobilizer.RestartMovement();
        }
    }

    private IEnumerator SpawnLaser(float laserDuration, float initialDelay)
    {
        Debug.Log("Charging Laser: " + initialDelay);
        // TODO: Add a laser charge animation
        
        yield return new WaitForSeconds(initialDelay);

        var shotSpawn = _cannon.GetShotSpawn();
        var laser = _cannon.GetLaser();
        
        var laserObj = Instantiate(laser, shotSpawn.position, shotSpawn.rotation);
        laserObj.transform.SetParent(transform);
        laserObj.GetComponent<PersistentLaserBeam>().SetDuration(laserDuration);
        
        yield return new WaitForSeconds(laserDuration);

        Debug.Log("Laser deactivated");
        // TODO: Add a laser deactivation animation
    }
    
    private IEnumerator CannonBall(float initialDelay)
    {
        Debug.Log("Charging CannonBall: " + initialDelay);
        yield return new WaitForSeconds(initialDelay);
        
        var position = _cannon.GetShotSpawn().position;
            
        var cannonBall = EnemyPoolManager.Instance.GetCannonBall();
        cannonBall.transform.position = position;
        cannonBall.transform.eulerAngles = _cannon.GetShotSpawn().transform.eulerAngles;
    }
    
    private IEnumerator SpawnBullets(float fireRate, float bulletCount, float initialDelay, BossBulletType projectile)
    {
        yield return new WaitForSeconds(initialDelay);
        
        for (var i = 0; i < bulletCount; i++)
        {
            // Break the loop if the boss is stunned
            if (_submodule.GetIsStunned())
                yield return null;

            var position = _cannon.GetShotSpawn().position;
            
            var bullet = EnemyPoolManager.Instance.GetBossBullet(projectile);
            bullet.transform.position = position;
            bullet.transform.eulerAngles = _cannon.GetShotSpawn().transform.eulerAngles;
            
            //AudioManager.Instance.PlayAudioClip(Sounds.SoundType.EnemyBlueShot, position);

            yield return new WaitForSeconds(fireRate);
        }
    }

    public override float GetTimeAfterExecuting()
    {
        return timeAfter;
    }
    
    [Serializable]
    public class MultiAttack
    {
        public MultiAttackType attackType;
        
        [Header("Laser Parameters")]
        public float laserDuration;
        
        [Header("Bullets Parameters")]
        public float fireRate;
        [Range(0, 10)] public int bulletCount;
        public BossBulletType projectile = BossBulletType.MediumBlue;
    
        [Header("CannonBall Parameters")]
        // No special parameters for cannonball...
        
        public float initialDelay;
        public bool stopMovement;
    }

    public enum MultiAttackType
    {
        ContinuousLaser,
        CannonBall,
        Bullets
    }
}
