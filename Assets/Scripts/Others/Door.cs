using System.Collections;
using UnityEngine;
using TMPro;

public class Door : MonoBehaviour
{
    public int killsToOpen;
    [Header("Objects")]
    public TextMeshProUGUI textObject;
    [Header("Trigger Properties")]
    public Spawner spawner;
    
    private ParticleSystem _pSystem;
    private Animator _animator;
    private bool _open;
    private int _killsLeft;
    
    private static readonly int IsClosed = Animator.StringToHash("IsClosed");

    private void Start()
    {
        EventManager.Instance.Subscribe("OnEnemyDead", OnEnemyDeath);
        
        _pSystem = GetComponentInChildren<ParticleSystem>();
        _animator = GetComponent<Animator>();
        
        _killsLeft = killsToOpen;
        textObject.text = _killsLeft.ToString();
    }

    private void OnEnemyDeath(params object[] parameters)
    {
        _killsLeft--;
        textObject.text = _killsLeft.ToString();
        
        if (_killsLeft > 0) 
            return;
        
        AudioManager.Instance.Play("TaskComplete");
        Open();
        
        if (_pSystem)
        {
            _pSystem.transform.parent = null;
            _pSystem.Play();
        }
        
        EventManager.Instance.Unsubscribe("OnEnemyDead", OnEnemyDeath);
    }

    private void Open()
    {
        _open = true;
        _animator.enabled = true;
    }

    private void Close()
    {
        _open = false;
           
        _animator.SetTrigger(IsClosed);

        if (spawner != null)
            spawner.SetCanSpawn(false);
    }
    
    private void OnTriggerEnter(Collider other)
    {
        if (other.gameObject.layer == 9 && _open)
            Close();
    }
}
