using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using UnityEditor;
using UnityEngine;

public abstract class Entity : MonoBehaviour, IDamageable<float, PlayerArm.ArmType, bool>
{
    [Header("Entity Parameters")]
    public float hp;
    public float movementSpeed;
    public float rotationSpeed;

    protected float _currentHp;

    //On Damaged VFX. 
    protected Renderer[] allRenderers;
    protected Material[] baseMats;
    protected Material damagedMat;
    
    private ParticleSystemForceField _forceField;

    protected virtual void Awake()
    {
        _currentHp = hp;
        
        // Get all renderers that are not of type LineRenderer
        allRenderers = GetComponentsInChildren<Renderer>().Where(x => x.GetType() != typeof(LineRenderer) && x.GetType() != typeof(ParticleSystemRenderer)).ToArray();
        
        baseMats = new Material[allRenderers.Length];
        for (var i = 0; i < allRenderers.Length; i++)
        {
            baseMats[i] = new Material(allRenderers[i].material);
        }

        damagedMat = new Material(Shader.Find("Unlit/Color"))
        {
            color = Color.white
        };
    }

    public virtual void TakeDamage(float damage, PlayerArm.ArmType aType = PlayerArm.ArmType.None, bool showDamage = true)
    {
        _currentHp -= damage;
        
        if (showDamage)
            StartCoroutine(ShowDamage());
        
        if (_currentHp <= 0)
            KillEntity();
    }

    protected virtual IEnumerator ShowDamage()
    {
        var renderers = allRenderers.Where(x => x != null).ToArray();
        foreach (var item in renderers)
            item.material = damagedMat;

        const float timer = 0.15f;
        yield return new WaitForSeconds(timer);

        BackToBaseMaterial();
    }
    
    // Modify the name of the following function to be more apropiate
    
    
    protected void BackToBaseMaterial()
    {
        for (var i = 0; i < allRenderers.Length; i++)
        {
            if (allRenderers[i] == null)
                continue;
            
            allRenderers[i].material = baseMats[i];
        }
    }
    
    public virtual void KillEntity()
    {
        Destroy(gameObject);
    }
    
    /// <summary>
    /// Get the particle system force field component for the merge / hacking effect
    /// </summary>
    /// <returns></returns>
    public ParticleSystemForceField GetParticleForceField()
    {
        if (_forceField == null)
            _forceField = GetComponentInChildren<ParticleSystemForceField>();
        
        return _forceField;
    }
}
