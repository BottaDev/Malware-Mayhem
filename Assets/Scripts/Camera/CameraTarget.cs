using System.Collections;
using UnityEngine;

public class CameraTarget : MonoBehaviour
{
    public float treshold;
    
    private Transform _player;
    private bool _playerSpawn = false;
    
    private void Awake()
    {
        StartCoroutine(WaitToPlayer());
    }

    private void Start()
    {
        EventManager.Instance?.Subscribe("OnPlayerSpawned", OnPlayerSpawned);
    }

    private void Update()
    {
        if (_player == null)
            return;

        Vector3 mousePos = InputManager.Instance.mousePosition;
        Vector3 targetPos = (_player.position + mousePos) / 2f;

        targetPos.x = Mathf.Clamp(targetPos.x, -treshold + _player.position.x, treshold + _player.position.x);
        targetPos.z = Mathf.Clamp(targetPos.z, -treshold + _player.position.z, treshold + _player.position.z);
        targetPos.y = 0;
        
        transform.position = targetPos;
    }

    private void OnPlayerSpawned(params object[] parameters)
    {
        _playerSpawn = (bool)parameters[0];
    }
    
    private IEnumerator WaitToPlayer()
    {
        if (EventManager.Instance != null)
        {
            yield return new WaitUntil(() => _playerSpawn);
            EventManager.Instance.Unsubscribe("OnPlayerSpawned", OnPlayerSpawned);
        }

        _player = GameObject.FindWithTag("Player").transform;

        yield return null;
    }
}