using MM.Entities.Player;
using MM.Events;
using UnityEngine;

namespace MM.Entities.Enemies.Bosses.Iset.SubModuleBosses 
{
    public class Hooks : MonoBehaviour
    {
        #region Private Variables

        [SerializeField] private GameObject bulletPrefab;
        [SerializeField] private GameObject model;
        [SerializeField] private Transform spawnPoint;
        [SerializeField] private float minSpawnRate = 1f;
        [SerializeField] private float maxSpawnRate = 2f;
        
        private Transform _playerTransform;
        private float _spawnRate;
        
        #endregion

        #region Monobehaviour Functions

        private void Awake()
        {
            ChooseSpawnRate();

#if UNITY_EDITOR
            _playerTransform = GameObject.FindWithTag("Player").GetComponent<Transform>();
#else
            EventManager.Instance.Subscribe(NameEvent.OnPlayerSpawned, OnPlayerSpawned);
#endif
        }
        
        private void Update()
        {
            if (_playerTransform == null) { return; }
            
            if(_spawnRate > 0)
            {
                _spawnRate -= Time.deltaTime;
            }
            else
            {
                Shoot();
            }
        }

        #endregion

        #region Private Functions

        private void Shoot()
        {
            spawnPoint.LookAt(_playerTransform);
            
            
            
            Instantiate(bulletPrefab, spawnPoint.position, spawnPoint.rotation);
            
            ChooseSpawnRate();
        }
        
        private void ChooseSpawnRate()
        {
            _spawnRate = Random.Range(minSpawnRate, maxSpawnRate);
        }

        #endregion

        #region Event Functions

        private void OnPlayerSpawned(params object[] parameters)
        {
            var player = (PlayerModel) parameters[0];
            _playerTransform = player.transform;
        }

        #endregion
    }
}