using System.Collections;
using UnityEngine;
using UnityEngine.SceneManagement;

public class LevelManager : MonoBehaviour
{
    public static LevelManager Instance = null;

    [Header("Boss Parameters")]
    [SerializeField] private GameObject bossSpawn;
    [SerializeField] private Transform bossSpawnPosition;
    [Tooltip("The time that the boss will spawn after the player spawning")]
    [SerializeField] private float initialSpawnTime = 8f;
    [Tooltip("The time that the boss will attack after spawning")] 
    [SerializeField] private float initialAttackTime = 3.5f;

    [Header("Player Parameters")] 
    [SerializeField] private Transform playerSpawnPosition;
    [SerializeField] private PlayerSpawn playerSpawn;

    private bool _canRefresh = true;
    private PlayerModel _player;

    private void Awake()
    {
        if (Instance == null)
            Instance = this;

        if (playerSpawn != null && playerSpawnPosition != null)
            Instantiate(playerSpawn, playerSpawnPosition.transform.position, Quaternion.identity, transform);
#if UNITY_EDITOR
        // For testing purposes
        else
            _player = GameObject.FindWithTag("Player")?.GetComponent<PlayerModel>();
#endif
    }

    private void Start()
    {
        EventManager.Instance.Subscribe(EventManager.NameEvent.OnPlayerSpawned, OnPlayerSpawned);
        EventManager.Instance.Subscribe(EventManager.NameEvent.OnPostProcessFinished, OnPostProcessFinished);
        EventManager.Instance.Subscribe(EventManager.NameEvent.OnTutorialSkip, SkipInitialWait);
        
        AudioManager.Instance.PlayMusic("Level 1-1");
    }

    public void LoseLevel()
    {
        UIManager.Instance.StartFadeIn();
        
        //AudioManager.Instance.PlayMusic("LoseLevel");

        Invoke(nameof(ShowLoseScene), 2f);
    }

    public void WinLevel()
    {
        UIManager.Instance.StartFadeIn();

        //AudioManager.Instance.PlayMusic("WinLevel");
        
        Invoke(nameof(ShowWinScene), 2f);
    }

    public PlayerModel GetPlayer()
    {
        return _player;
    }

    private void ShowLoseScene()
    {
        ResetTimeScale();
        
        SceneLoader.Instance.ChangeLevel("LoseScene");
    }

    private void ShowWinScene()
    {
        ResetTimeScale();
        
        SceneLoader.Instance.ChangeLevel("WinScene");
    }

    private static void ResetTimeScale()
    {
        Time.timeScale = 1;        
    }
    
    private bool _mainBossSpawned;      // Prevent to spawn the boss again when the player returns to the main fight
    private void OnPlayerSpawned(params object[] parameters)
    {
        _player = (PlayerModel) parameters[1];
        
        Invoke(nameof(SpawnBoss), initialSpawnTime);
    }

    private void OnPostProcessFinished(params object[] parameters)
    {
        if(gameObject.activeInHierarchy)
            StartCoroutine(SetPlayer());
    }

    private void SkipInitialWait(params object[] parameters)
    {
        initialSpawnTime = 0;
        initialAttackTime = 0;
        
        SpawnBoss();
    }
    
    private void SpawnBoss()
    {
        if (_mainBossSpawned)
            return;
        
        if (bossSpawn != null && bossSpawnPosition != null)
            Instantiate(bossSpawn, bossSpawnPosition.transform.position, Quaternion.identity, transform);

        _mainBossSpawned = true;
        
        Invoke(nameof(TriggerBossAttack), initialAttackTime);
    }

    private void TriggerBossAttack()
    {
        EventManager.Instance.Trigger(EventManager.NameEvent.OnInitialAttackWait);
    }

    private IEnumerator SetPlayer()
    {
        yield return new WaitUntil(() => _canRefresh);
        
        _player = GameObject.FindWithTag("Player")?.GetComponent<PlayerModel>();
    }

    public void ChangeStatus(bool status)
    {
        _canRefresh = status;
    }
    
    
}
