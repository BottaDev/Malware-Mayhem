using System.Collections;
using UnityEngine;
using TMPro;

public class T_Door : MonoBehaviour
{
    public TextMeshProUGUI textObject;
    public int killsToOpen;
    private int _killsLeft;
    private ParticleSystem _pSystem;
    private Transform t;
    
    private void Start()
    {
        EventManager.Instance.Subscribe(EventManager.NameEvent.OnEnemyDead, OnEnemyDeath);
        
        t = GetComponent<Transform>();
        _pSystem = GetComponentInChildren<ParticleSystem>();
        
        _killsLeft = killsToOpen;
        textObject.text = _killsLeft + "";
    }

    private void OnEnemyDeath(params object[] parameters)
    {
        _killsLeft -= 1;
        textObject.text = _killsLeft + "";
        if (_killsLeft > 0) return;
        
        AudioManager.Instance.Play("TaskComplete");
        StartCoroutine(Open());
        if (_pSystem)
        {
            _pSystem.transform.parent = null;
            _pSystem.Play();
        }
        EventManager.Instance.Unsubscribe(EventManager.NameEvent.OnEnemyDead, OnEnemyDeath);
    }

    private IEnumerator Open()
    {
        for (int i = 0; i < 60; i++)
        {
            t.position -= t.up * +.2f;
            yield return new WaitForSeconds(.1f);
        }
    }
}
